
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://xuan-insr.github.io/blog/prometheus/">
      
      
        <link rel="prev" href="../2024-07-07-sun/">
      
      
        <link rel="next" href="../git-remote/">
      
      
      <link rel="icon" href="../../logo.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.34">
    
    
      
        <title>Prometheus - å’¸é±¼æš„çš„ä»£ç ç©ºé—´</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.35f28582.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Serif SC";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/timeago.css">
    
      <link rel="stylesheet" href="../../from_oi_wiki/css/extra.css?v=13">
    
      <link rel="stylesheet" href="../../css/status.css">
    
      <link rel="stylesheet" href="../../css/neoteroi-mkdocs.css">
    
      <link rel="stylesheet" href="../../termynal.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-JT9BRCXKJJ"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-JT9BRCXKJJ",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-JT9BRCXKJJ",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="cyan" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prometheus" class="md-skip">
          è·³è½¬è‡³
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="é¡µçœ‰">
    <a href="../.." title="å’¸é±¼æš„çš„ä»£ç ç©ºé—´" class="md-header__button md-logo" aria-label="å’¸é±¼æš„çš„ä»£ç ç©ºé—´" data-md-component="logo">
      
  <img src="../../logo.ico" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            å’¸é±¼æš„çš„ä»£ç ç©ºé—´
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Prometheus
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="cyan" data-md-color-accent="cyan"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="orange" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="æœç´¢" placeholder="æœç´¢" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="æŸ¥æ‰¾">
        
        <button type="reset" class="md-search__icon md-icon" title="æ¸…ç©ºå½“å‰å†…å®¹" aria-label="æ¸…ç©ºå½“å‰å†…å®¹" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/xuan-insr/xuan-insr.github.io" title="å‰å¾€ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    xuan-insr/å’¸é±¼æš„çš„ä»£ç ç©ºé—´
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="æ ‡ç­¾" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="https://xuan-insr.github.io/" class="md-tabs__link">
        
  
    
  
  ğŸ¡ ä¸»é¡µ

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  éšæœºç¬”è®°

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="å¯¼èˆªæ " data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="å’¸é±¼æš„çš„ä»£ç ç©ºé—´" class="md-nav__button md-logo" aria-label="å’¸é±¼æš„çš„ä»£ç ç©ºé—´" data-md-component="logo">
      
  <img src="../../logo.ico" alt="logo">

    </a>
    å’¸é±¼æš„çš„ä»£ç ç©ºé—´
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/xuan-insr/xuan-insr.github.io" title="å‰å¾€ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    xuan-insr/å’¸é±¼æš„çš„ä»£ç ç©ºé—´
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://xuan-insr.github.io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ğŸ¡ ä¸»é¡µ
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    éšæœºç¬”è®°
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            éšæœºç¬”è®°
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    å½’æ¡£
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            å½’æ¡£
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-09
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    åˆ†ç±»
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            åˆ†ç±»
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/booksgit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ğŸ“šGit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/booksmkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ğŸ“šMkDocs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/newspaperobservability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ğŸ“°Observability
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/newspaperprometheus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ğŸ“°Prometheus
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/rainbowdaily/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ğŸŒˆDaily
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/rainbowtopics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ğŸŒˆTopics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/sparkleszsh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    âœ¨ZSH
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/writing_hand_tone1git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    âœğŸ»Git
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/writing_hand_tone1python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    âœğŸ»Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-concepts--åŸºæœ¬æ¦‚å¿µ" class="md-nav__link">
    <span class="md-ellipsis">
      1 Concepts | åŸºæœ¬æ¦‚å¿µ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1 Concepts | åŸºæœ¬æ¦‚å¿µ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-data-model--æ•°æ®æ¨¡å‹" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 Data Model | æ•°æ®æ¨¡å‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-prometheus-å¦‚ä½•é‡‡é›†æŒ‡æ ‡" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 Prometheus å¦‚ä½•é‡‡é›†æŒ‡æ ‡
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-metric-types--æŒ‡æ ‡ç±»å‹" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 Metric Types | æŒ‡æ ‡ç±»å‹
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-querying--æŸ¥è¯¢" class="md-nav__link">
    <span class="md-ellipsis">
      2 Querying | æŸ¥è¯¢
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 Querying | æŸ¥è¯¢">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-data-types--æ•°æ®ç±»å‹" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 Data Types | æ•°æ®ç±»å‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-time-series-selectors--æ—¶é—´åºåˆ—é€‰æ‹©å™¨" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 Time Series Selectors | æ—¶é—´åºåˆ—é€‰æ‹©å™¨
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-operators--è¿ç®—ç¬¦" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 Operators | è¿ç®—ç¬¦
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3 Operators | è¿ç®—ç¬¦">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#231-ç®—æœ¯äºŒå…ƒè¿ç®—ç¬¦" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.1 ç®—æœ¯äºŒå…ƒè¿ç®—ç¬¦
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#232-æ¯”è¾ƒäºŒå…ƒè¿ç®—ç¬¦" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.2 æ¯”è¾ƒäºŒå…ƒè¿ç®—ç¬¦
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#233-é€»è¾‘é›†åˆäºŒå…ƒè¿ç®—ç¬¦" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.3 é€»è¾‘ï¼ˆé›†åˆï¼‰äºŒå…ƒè¿ç®—ç¬¦
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#234-vector-matching" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.4 Vector Matching
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#235-èšåˆè¿ç®—ç¬¦" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.5 èšåˆè¿ç®—ç¬¦
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-functions--å‡½æ•°" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 Functions | å‡½æ•°
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4 Functions | å‡½æ•°">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#æ•°å­¦è¿ç®—" class="md-nav__link">
    <span class="md-ellipsis">
      æ•°å­¦è¿ç®—
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#æ—¶é—´" class="md-nav__link">
    <span class="md-ellipsis">
      æ—¶é—´
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#åˆ¤æ–­æ˜¯å¦ä¸ºç©º" class="md-nav__link">
    <span class="md-ellipsis">
      åˆ¤æ–­æ˜¯å¦ä¸ºç©º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#é™åˆ¶æ ·æœ¬å€¼" class="md-nav__link">
    <span class="md-ellipsis">
      é™åˆ¶æ ·æœ¬å€¼
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#å˜åŒ–æƒ…å†µ" class="md-nav__link">
    <span class="md-ellipsis">
      å˜åŒ–æƒ…å†µ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#æ ‡ç­¾æ“ä½œ" class="md-nav__link">
    <span class="md-ellipsis">
      æ ‡ç­¾æ“ä½œ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ç±»å‹è½¬æ¢" class="md-nav__link">
    <span class="md-ellipsis">
      ç±»å‹è½¬æ¢
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#æ’åº" class="md-nav__link">
    <span class="md-ellipsis">
      æ’åº
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ç”¨äº-rv-çš„èšåˆ" class="md-nav__link">
    <span class="md-ellipsis">
      ç”¨äº RV çš„èšåˆ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ç›´æ–¹å›¾ç›¸å…³å‡½æ•°" class="md-nav__link">
    <span class="md-ellipsis">
      ç›´æ–¹å›¾ç›¸å…³å‡½æ•°
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-subqueries--å­æŸ¥è¯¢" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 Subqueries | å­æŸ¥è¯¢
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-api" class="md-nav__link">
    <span class="md-ellipsis">
      2.6 API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.6 API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#261-å³æ—¶æŸ¥è¯¢" class="md-nav__link">
    <span class="md-ellipsis">
      2.6.1 å³æ—¶æŸ¥è¯¢
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#262-èŒƒå›´æŸ¥è¯¢" class="md-nav__link">
    <span class="md-ellipsis">
      2.6.2 èŒƒå›´æŸ¥è¯¢
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#å…¶ä»–æ¥å£" class="md-nav__link">
    <span class="md-ellipsis">
      å…¶ä»–æ¥å£
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-examples" class="md-nav__link">
    <span class="md-ellipsis">
      3 Examples
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    å›åˆ°ä¸»é¡µ
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    å…ƒæ•°æ®
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2024-07-09 00:00:00" class="md-ellipsis">2024å¹´7æœˆ9æ—¥</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            åˆ†ç±»äº
                            
                              <a href="../category/rainbowtopics/">ğŸŒˆTopics</a>, 
                              <a href="../category/newspaperobservability/">ğŸ“°Observability</a>, 
                              <a href="../category/newspaperprometheus/">ğŸ“°Prometheus</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              éœ€è¦ 22 åˆ†é’Ÿé˜…è¯»æ—¶é—´
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        


<h1 id="prometheus">Prometheus<a class="headerlink" href="#prometheus" title="Permanent link">&para;</a></h1>
<p><a href="https://prometheus.io/">Prometheus</a> é‡‡é›†ç³»ç»ŸæŒ‡æ ‡ (metrics)ï¼Œå¹¶å°†å…¶å­˜å‚¨ä¸ºæ—¶é—´åºåˆ— (time series)ï¼›å¹¶æä¾›äº†ä¸€å¥—å¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€ PromQLï¼Œç”¨äºæŸ¥è¯¢å’Œåˆ†æè¿™äº›æŒ‡æ ‡ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ Grafana æ¥æŠŠè¿™äº›æŒ‡æ ‡å¯è§†åŒ–ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç» Prometheus çš„åŸºæœ¬æ¦‚å¿µå’ŒæŸ¥è¯¢æ–¹æ³•ã€‚</p>
<!-- more -->

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>å¦‚æœæš‚æ—¶ä»æœªå®é™…æ¥è§¦è¿‡ Prometheusï¼Œæ‚¨å¯ä»¥åœ¨ <a href="https://grafana.com/blog/2019/12/04/how-to-explore-prometheus-with-easy-hello-world-projects/">è¿™é‡Œ</a> æ‰¾åˆ°ä¸€ä¸ª minimum çš„ end-to-end ç¤ºä¾‹ã€‚</p>
</div>
<h2 id="1-concepts--åŸºæœ¬æ¦‚å¿µ">1 Concepts | åŸºæœ¬æ¦‚å¿µ<a class="headerlink" href="#1-concepts--åŸºæœ¬æ¦‚å¿µ" title="Permanent link">&para;</a></h2>
<h3 id="11-data-model--æ•°æ®æ¨¡å‹">1.1 Data Model | æ•°æ®æ¨¡å‹<a class="headerlink" href="#11-data-model--æ•°æ®æ¨¡å‹" title="Permanent link">&para;</a></h3>
<p>Prometheus å­˜å‚¨çš„å†…å®¹æ˜¯ä¸€ç³»åˆ— <code>(metric_name, labels, timestamp, value)</code>ï¼›å…¶ä¸­ï¼š</p>
<ul>
<li><code>metric_name</code> æ˜¯æŒ‡æ ‡åï¼Œç”¨äºè¡¨æ˜æŒ‡æ ‡çš„å«ä¹‰ (e.g. <code>http_requests_total</code>)ï¼›</li>
<li><code>labels</code> æ˜¯å¯é€‰çš„ï¼ŒåŒ…å«ä¸€ç»„ä»»æ„é”®å€¼å¯¹ï¼Œç”¨äºåŒºåˆ†æŒ‡æ ‡çš„ä¸åŒç»´åº¦ (e.g. <code>method="GET"</code>)ï¼›<ul>
<li>ä¾‹å¦‚ <code>http_requests_total{method="GET", status="200"}</code> è¡¨ç¤º <code>GET</code> è¯·æ±‚è¿”å› <code>200</code> çš„æ€»æ¬¡æ•°ï¼›</li>
</ul>
</li>
<li><code>(timestamp, value)</code> è¢«åˆå¹¶ç§°ä¸º <code>sample</code>ï¼Œè¡¨ç¤ºåœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸‹ <code>metric_name{labels}</code> çš„å€¼ã€‚<ul>
<li><code>timestamp</code> çš„ç²¾åº¦æ˜¯æ¯«ç§’ï¼Œ<code>value</code> æ˜¯ä¸€ä¸ª float64 æ•°å€¼ã€‚</li>
</ul>
</li>
</ul>
<h3 id="12-prometheus-å¦‚ä½•é‡‡é›†æŒ‡æ ‡">1.2 Prometheus å¦‚ä½•é‡‡é›†æŒ‡æ ‡<a class="headerlink" href="#12-prometheus-å¦‚ä½•é‡‡é›†æŒ‡æ ‡" title="Permanent link">&para;</a></h3>
<p>å¸¸è§è¯­è¨€éƒ½æœ‰ Prometheus çš„ client libraryï¼Œç”¨äºåœ¨åº”ç”¨ç¨‹åºä¸­é‡‡é›†æŒ‡æ ‡å¹¶æš´éœ²å‡ºæ¥ã€‚ä¾‹å¦‚ï¼ŒæœåŠ¡å¯ä»¥åœ¨ <code>/metrics</code> è·¯å¾„ä¸‹æš´éœ²æŒ‡æ ‡ï¼ŒæŒ‡æ ‡å¯èƒ½å½¢å¦‚ï¼š</p>
<div class="highlight"><pre><span></span><code># HELP python_gc_objects_collected_total Objects collected during gc
# TYPE python_gc_objects_collected_total counter
python_gc_objects_collected_total{generation=&quot;0&quot;} 4.6086284e+07
python_gc_objects_collected_total{generation=&quot;1&quot;} 2.1484146e+07
python_gc_objects_collected_total{generation=&quot;2&quot;} 6.290886e+06
# HELP python_gc_objects_uncollectable_total Uncollectable objects found during GC
# TYPE python_gc_objects_uncollectable_total counter
python_gc_objects_uncollectable_total{generation=&quot;0&quot;} 0.0
python_gc_objects_uncollectable_total{generation=&quot;1&quot;} 0.0
python_gc_objects_uncollectable_total{generation=&quot;2&quot;} 0.0
<span class="hll"># HELP http_requests_total Total number of HTTP requests
</span><span class="hll"># TYPE http_requests_total counter
</span><span class="hll">http_requests_total{method=&quot;post&quot;,code=&quot;200&quot;} 1027.0
</span><span class="hll">http_requests_total{method=&quot;post&quot;,code=&quot;400&quot;} 3.0
</span><span class="hll">http_requests_total{method=&quot;get&quot;,code=&quot;200&quot;} 10000.0
</span></code></pre></div>
<p>åœ¨æœåŠ¡ä¸­ï¼Œæ¯æ¬¡æ¥å—åˆ° http è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®è¯·æ±‚çš„ method å’Œ code ä¿®æ”¹ä¸€æ¬¡ <code>http_requests_total</code> æŒ‡æ ‡ã€‚Prometheus æ¯éš”æŒ‡å®šçš„ä¸€æ®µæ—¶é—´ä¼šå» <code>/metrics</code> æ‹‰å–è¿™äº›æŒ‡æ ‡ï¼Œè·å¾—ä¸Šé¢ä»£ç å—æ‰€ç¤ºçš„æ•°æ®ï¼Œä»è€Œè·å–åˆ° <code>(metric_name, labels, timestamp, value)</code> çš„ data modelã€‚</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>åœ¨ Prometheus çœ‹æ¥ï¼Œä¸€ä¸ª <code>metric_name{labels}</code> çš„å€¼æ˜¯ä¸€ä¸ªæ—¶é—´åºåˆ—ï¼Œå³ä¸€ç³»åˆ— <code>(timestamp, value)</code> çš„é›†åˆã€‚å¦‚æœ <code>labels</code> çš„å–å€¼å‘ç”Ÿå˜åŒ–ï¼ŒPrometheus ä¼šè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæ–°çš„æ—¶é—´åºåˆ—ã€‚</p>
</div>
<p>å¦å¤–ï¼Œåœ¨æ¯æ¬¡æŠ“å–æ•°æ®æ—¶ï¼ŒPrometheus è¿˜ä¼šé¢å¤–è®°å½•ä»¥ä¸‹æŒ‡æ ‡ï¼š</p>
<ul>
<li><code>up</code>ï¼Œ1 è¡¨ç¤ºæŠ“å–æˆåŠŸï¼Œ0 è¡¨ç¤ºå¤±è´¥ï¼›è¿™å¯¹äºæ£€æŸ¥å®ä¾‹æ˜¯å¦å¯ç”¨éå¸¸æœ‰ç”¨ï¼›</li>
<li><code>scrape_duration_seconds</code>ï¼ŒæŠ“å–æ•°æ®çš„è€—æ—¶ï¼›</li>
<li>è¿˜æœ‰æ›´å¤šï¼Œå‚è§ <a href="https://prometheus.io/docs/concepts/jobs_instances/#automatically-generated-labels-and-time-series">Automatically generated labels and time series</a>ã€‚</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>æœ‰æ—¶ï¼Œéœ€è¦è¢«ç›‘æ§çš„ç»„ä»¶å¯èƒ½ä¸æ”¯æŒè¢« Prometheus ç›´æ¥æŠ“å–ï¼Œæ­¤æ—¶å¯ä»¥åœ¨ç»„ä»¶ä¸­ <a href="https://prometheus.io/docs/instrumenting/pushing/">ä¸»åŠ¨ Push</a>ï¼›ä½†è¿™ä¸ä¼šè¢«åŒ…å«åœ¨æœ¬æ–‡çš„å†…å®¹ä¸­ã€‚ã€‚</p>
</div>
<h3 id="13-metric-types--æŒ‡æ ‡ç±»å‹">1.3 Metric Types | æŒ‡æ ‡ç±»å‹<a class="headerlink" href="#13-metric-types--æŒ‡æ ‡ç±»å‹" title="Permanent link">&para;</a></h3>
<p>Prometheus çš„ client library æ”¯æŒä»¥ä¸‹ 4 ç§æŒ‡æ ‡ç±»å‹ï¼›ä½†è¿™åªæ˜¯ä¸€ä¸ªä¾¿äºä½¿ç”¨çš„å°è£…ï¼Œåœ¨ Prometheus ä¸­çš„æŒ‡æ ‡ä»ç„¶åªæœ‰ <code>(metric_name, labels, timestamp, value)</code></p>
<ul>
<li><code>Counter</code>ï¼šåªå¢ä¸å‡çš„è®¡æ•°å™¨ã€‚åœ¨ client ä¸­ï¼Œæ”¯æŒ <code>c.inc()</code> æˆ– <code>c.inc(1.6)</code> çš„æ“ä½œæ¥å¢åŠ å…¶å€¼ã€‚</li>
<li><code>Gauge</code>ï¼šå¯å¢å¯å‡çš„å€¼ã€‚åœ¨ client ä¸­ï¼Œæ”¯æŒ <code>g.set(3.2)</code>, <code>g.inc()</code> æˆ– <code>g.dec(10)</code> çš„æ“ä½œæ¥ä¿®æ”¹å…¶å€¼ã€‚</li>
<li><code>Histogram</code>ï¼šå¯¹è§‚å¯Ÿçš„ç»“æœè¿›è¡Œé‡‡æ ·ï¼Œè®°å½•åˆ°é¢„å…ˆæŒ‡å®šå¥½çš„è‹¥å¹²èŒƒå›´ (bucket) ä¸­ï¼Œç”¨äºç»Ÿè®¡æ•°æ®çš„åˆ†å¸ƒæƒ…å†µã€‚åœ¨ client ä¸­ï¼Œæ”¯æŒ <code>h.observe(3.2)</code> çš„æ“ä½œæ¥è®°å½•æ•°æ®ã€‚å‚è§ä¸‹é¢çš„ä¾‹å­ã€‚</li>
<li><code>Summary</code>ï¼šå¯¹è§‚å¯Ÿçš„ç»“æœè¿›è¡Œé‡‡æ ·ï¼Œè®°å½•åˆ°é¢„å…ˆæŒ‡å®šå¥½çš„è‹¥å¹²åˆ†ä½æ•° (quantile) ä¸­ï¼Œç”¨äºç»Ÿè®¡æ•°æ®çš„åˆ†å¸ƒæƒ…å†µã€‚åœ¨ client ä¸­ï¼Œæ”¯æŒ <code>s.observe(3.2)</code> çš„æ“ä½œæ¥è®°å½•æ•°æ®ã€‚å‚è§ä¸‹é¢çš„ä¾‹å­ã€‚</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>è¯·æ³¨æ„ï¼šå¹¶éæ‰€æœ‰çš„ client library éƒ½æ”¯æŒæ‰€æœ‰çš„æŒ‡æ ‡ç±»å‹ã€‚ä¾‹å¦‚ï¼Œ<a href="https://github.com/prometheus/client_python/issues/888">æˆªè‡³ç›®å‰</a> Python çš„ client library <code>prometheus_client</code> ä¸æ”¯æŒ <code>Summary</code> çš„ quantile é…ç½®ã€‚</p>
</div>
<details class="example">
<summary>Histogram</summary>
<p><code>Histogram</code> ä¼šå°†è§‚å¯Ÿåˆ°çš„æ•°æ®åˆ†æ¡¶ (bucket)ï¼Œç„¶åè®°å½•æ¯ä¸ªåˆ†æ¡¶çš„æ•°æ®é‡ã€‚åœ¨åˆ›å»ºä¸€ä¸ª <code>Histogram</code> æŒ‡æ ‡æ—¶ï¼Œéœ€è¦æŒ‡å®šå„ä¸ª bucket çš„ä¸Šé™å€¼ï¼›<code>Histogram</code> å®é™…ä¸Šä¼šåˆ›å»ºä¸€ç³»åˆ—ä¸åŒçš„ metric æ¥è®°å½•è§‚å¯Ÿå¾—åˆ°çš„æ•°æ®ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p>
<p>ä¸¾ä¾‹è€Œè¨€ï¼Œæˆ‘ä»¬ä½¿ç”¨åä¸º <code>http_request_duration_seconds</code> çš„ histogram æŒ‡æ ‡æ¥è®°å½•è¯·æ±‚çš„å“åº”æ—¶é—´ï¼›å®ƒåŒ…å« <code>api</code> å’Œ <code>method</code> ä¸¤ä¸ª labelï¼›æˆ‘ä»¬å®šä¹‰äº†å¦‚ä¸‹çš„å‡ ä¸ª bucket: <code>(0.1, 0.5, 1.0, Inf)</code>ã€‚é‚£ä¹ˆï¼Œå‡å¦‚æœ‰ <code class="highlight"><span class="n">http_request_duration_seconds</span><span class="p">(</span><span class="n">api</span><span class="o">=</span><span class="s2">&quot;/foo&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span></code>ï¼Œé‚£ä¹ˆ client ä¼šè®°å½•å¦‚ä¸‹çš„æ•°æ®ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code>http_request_duration_seconds_bucket{le=&quot;0.1&quot;,api=&quot;/foo&quot;,method=&quot;GET&quot;} 0
http_request_duration_seconds_bucket{le=&quot;0.5&quot;,api=&quot;/foo&quot;,method=&quot;GET&quot;} 0
http_request_duration_seconds_bucket{le=&quot;1.0&quot;,api=&quot;/foo&quot;,method=&quot;GET&quot;} 1
http_request_duration_seconds_bucket{le=&quot;+Inf&quot;,api=&quot;/foo&quot;,method=&quot;GET&quot;} 1

http_request_duration_seconds_sum{api=&quot;/foo&quot;,method=&quot;GET&quot;} 0.8

http_request_duration_seconds_count{api=&quot;/foo&quot;,method=&quot;GET&quot;} 1
</code></pre></div></td></tr></table></div>
<p>1-4 è¡Œçš„å‡ ä¸ª <code>&lt;metricName&gt;_bucket</code> ä¸­è®°å½•äº†è½åˆ°å„ä¸ª bucket çš„æ•°æ®é‡ï¼›<code>le</code> (less than or equal to) è¡¨ç¤ºä¸å¤§äºè¯¥å€¼çš„ observe æ¬¡æ•°ã€‚ç¬¬ 6 è¡Œçš„ <code>&lt;metricName&gt;_sum</code> è®°å½•äº†æ‰€æœ‰ observe çš„æ•°æ®å’Œï¼Œç¬¬ 8 è¡Œçš„ <code>&lt;metricName&gt;_count</code> è®°å½•äº† observe çš„æ€»é‡ã€‚</p>
<p>åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¦‚æœæœ‰ <code class="highlight"><span class="n">http_request_duration_seconds</span><span class="p">(</span><span class="n">api</span><span class="o">=</span><span class="s2">&quot;/foo&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span></code>ï¼Œé‚£ä¹ˆæ•°æ®ä¼šå˜ä¸ºï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code>http_request_duration_seconds_bucket{le=&quot;0.1&quot;,api=&quot;/foo&quot;,method=&quot;GET&quot;} 0
http_request_duration_seconds_bucket{le=&quot;0.5&quot;,api=&quot;/foo&quot;,method=&quot;GET&quot;} 1
http_request_duration_seconds_bucket{le=&quot;1.0&quot;,api=&quot;/foo&quot;,method=&quot;GET&quot;} 2
http_request_duration_seconds_bucket{le=&quot;+Inf&quot;,api=&quot;/foo&quot;,method=&quot;GET&quot;} 2

http_request_duration_seconds_sum{api=&quot;/foo&quot;,method=&quot;GET&quot;} 1.2

http_request_duration_seconds_count{api=&quot;/foo&quot;,method=&quot;GET&quot;} 2
</code></pre></div></td></tr></table></div>
<p>å¦‚æœè¿˜æœ‰ <code class="highlight"><span class="n">http_request_duration_seconds</span><span class="p">(</span><span class="n">api</span><span class="o">=</span><span class="s2">&quot;/bar&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="mf">1.2</span><span class="p">)</span></code>ï¼Œé‚£ä¹ˆä¼šæ–°å¢ä¸ä¸Šè¿°ç±»ä¼¼çš„ 6 ä¸ª time seriesã€‚</p>
</details>
<details class="example">
<summary>Summary</summary>
<p>ä¸ <code>Histogram</code> ç±»ä¼¼ï¼Œ<code>Summary</code> ä¹Ÿä¼šåˆ›å»ºä¸€ç³»åˆ—ä¸åŒçš„ metric æ¥è®°å½•è§‚å¯Ÿå¾—åˆ°çš„æ•°æ®ï¼›ä½†å®ƒä¼šè®°å½•ä¸åŒçš„åˆ†ä½æ•° (quantile) è€Œéé¢„å…ˆå®šä¹‰çš„ bucketã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre><span></span><code>http_request_duration_seconds{quantile=&quot;0.5&quot;} 0.232227334
http_request_duration_seconds{quantile=&quot;0.90&quot;} 0.821139321
http_request_duration_seconds{quantile=&quot;0.95&quot;} 1.528948804
http_request_duration_seconds{quantile=&quot;0.99&quot;} 2.829188272
http_request_duration_seconds{quantile=&quot;1&quot;} 34.283829292

http_request_duration_seconds_sum 8953.332
http_request_duration_seconds_count 27892
</code></pre></div>
<p>ç”±äº <code>Summary</code> éœ€è¦ä½¿ç”¨æµå¼ç®—æ³•æ¥è®¡ç®—åˆ†ä½æ•°ï¼Œå› æ­¤å®ƒçš„è®¡ç®—é‡ä¼šæ¯” <code>Histogram</code> å¤§å¾—å¤šã€‚</p>
</details>
<p>å…³äºå¦‚ä½•é€‰æ‹© <code>Histogram</code> å’Œ <code>Summary</code>ï¼Œè¯·å‚è€ƒ <a href="https://prometheus.io/docs/practices/histograms/">Histograms and Summaries | Prometheus</a>ã€‚</p>
<h2 id="2-querying--æŸ¥è¯¢">2 Querying | æŸ¥è¯¢<a class="headerlink" href="#2-querying--æŸ¥è¯¢" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Thanos</p>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç» Prometheusï¼›ä½†åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¯èƒ½ä¼šä½¿ç”¨ <a href="https://thanos.io/">Thanos</a> æ¥æ‰©å±• Prometheus çš„åŠŸèƒ½ã€‚Thanos æä¾›äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œä¾‹å¦‚é•¿æœŸå­˜å‚¨ã€æŸ¥è¯¢ä¼˜åŒ–ã€æ•°æ®å‹ç¼©ç­‰ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæ¯ä¸ªé›†ç¾¤çš„ Prometheus è´Ÿè´£æ”¶é›†æ‰€åœ¨é›†ç¾¤å„æœåŠ¡çš„ metrics å¹¶æä¾›ä¸€å®šçš„æŸ¥è¯¢èƒ½åŠ›ï¼›è€Œ Thanos ä»¥ sidecar çš„å½¢å¼æ•´åˆå„ä¸ªé›†ç¾¤çš„ Prometheus é‡‡é›†çš„æŒ‡æ ‡å¹¶é•¿æœŸä¿å­˜ï¼Œ<strong>å¹¶åŒæ ·é€‚ç”¨ PromQL æŸ¥è¯¢</strong>ã€‚</p>
</div>
<h3 id="21-data-types--æ•°æ®ç±»å‹">2.1 Data Types | æ•°æ®ç±»å‹<a class="headerlink" href="#21-data-types--æ•°æ®ç±»å‹" title="Permanent link">&para;</a></h3>
<p>åœ¨ PromQL ä¸­ï¼Œå¤§å¤šæ•°è¡¨è¾¾å¼å½’å±äºä»¥ä¸‹ 3 ç§ç±»å‹ä¹‹ä¸€ï¼š</p>
<ul>
<li>Scalarï¼šå•ä¸ªæµ®ç‚¹æ•°æ•°å€¼ï¼›</li>
<li>Instant vectorï¼šä¸€ç»„æ—¶é—´åºåˆ—ï¼Œæ¯ä¸ªæ—¶é—´åºåˆ—åŒ…å«å®ƒåœ¨æŸ¥è¯¢æ—¶é—´ç‚¹å‰æœ€åä¸€æ¬¡è¢«é‡‡æ ·åˆ°çš„å€¼ã€‚ä¾‹å¦‚ Query <code>http_requests_total</code> æˆ–è€… <code>http_requests_total{method="GET"}</code> è¿”å›åœ¨ query timestamp è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹å‰æ¯ä¸ªæ—¶é—´åºåˆ—æœ€åä¸€æ¬¡è¢«é‡‡æ ·åˆ°çš„å€¼ï¼›<ul>
<li>è¯·æ³¨æ„ï¼šå³ä½¿ <code>http_requests_total{method="GET"}</code> å¾—åˆ°çš„ instant vector åªåŒ…å« 1 ä¸ªå…ƒç´ ï¼Œå®ƒä¹Ÿä¸èƒ½è¢«è§†ä¸º scalarã€‚</li>
</ul>
</li>
<li>Range vectorï¼šä¸€ç»„æ—¶é—´åºåˆ—ï¼Œæ¯ä¸ªæ—¶é—´åºåˆ—åŒ…å«å®ƒåœ¨æŸ¥è¯¢æ—¶é—´æ®µå†…æ¯ä¸ªæ—¶é—´ç‚¹çš„å€¼ï¼Œä¾‹å¦‚ <code>http_requests_total[5m]</code> è¿”å›åœ¨ 5 åˆ†é’Ÿå†…æ¯ä¸ªæ—¶é—´åºåˆ—çš„å€¼ã€‚</li>
</ul>
<p>å¦‚æœæˆ‘ä»¬ç”¨ Python åšç±»æ¯”çš„è¯ï¼Œä¸Šé¢çš„ä¸‰ä¸ªç±»å‹å¯ä»¥ä»¥å¦‚ä¸‹æ–¹å¼è¡¨ç¤ºï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="hll"><span class="nb">type</span> <span class="n">Scalar</span> <span class="o">=</span> <span class="nb">float</span>
</span>
<span class="nb">type</span> <span class="n">Labels</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="nb">type</span> <span class="n">Sample</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Timestamp</span><span class="p">,</span> <span class="n">Scalar</span><span class="p">]</span>

<span class="nb">type</span> <span class="n">LabeledSample</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Labels</span><span class="p">,</span> <span class="n">Sample</span><span class="p">]</span>
<span class="hll"><span class="nb">type</span> <span class="n">InstantVector</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">LabeledSample</span><span class="p">]</span>
</span>
<span class="nb">type</span> <span class="n">TimeStamp</span> <span class="o">=</span> <span class="nb">int</span>
<span class="nb">type</span> <span class="n">TimeSeries</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">Sample</span><span class="p">]</span>
<span class="nb">type</span> <span class="n">LabeledTimeSeries</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Labels</span><span class="p">,</span> <span class="n">TimeSeries</span><span class="p">]</span>
<span class="hll"><span class="nb">type</span> <span class="n">RangeVector</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">LabeledTimeSeries</span><span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="22-time-series-selectors--æ—¶é—´åºåˆ—é€‰æ‹©å™¨">2.2 Time Series Selectors | æ—¶é—´åºåˆ—é€‰æ‹©å™¨<a class="headerlink" href="#22-time-series-selectors--æ—¶é—´åºåˆ—é€‰æ‹©å™¨" title="Permanent link">&para;</a></h3>
<p>ä»¥ä¸‹è¡¨è¾¾å¼å…·æœ‰ç±»å‹ <code>InstantVector</code>ï¼š</p>
<ul>
<li><code>http_requests_total</code></li>
<li><code>http_requests_total{method="GET"}</code><ul>
<li>å¯¹äºæ²¡æœ‰è¢« matchers æåŠçš„ labelï¼Œåˆ™ä»»ä½•å€¼å…¨éƒ¨æ¥å—ã€‚</li>
<li>å¯¹äºåŒä¸€ä¸ª labelï¼Œå¯ä»¥æœ‰å¤šä¸ª matchersï¼Œå®ƒä»¬ä¹‹é—´æ˜¯ AND å…³ç³»ã€‚</li>
</ul>
</li>
<li><code>{__name__="http_requests_total", method="GET"}</code><ul>
<li><code>__name__</code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ labelï¼Œç”¨äºåŒ¹é…æŒ‡æ ‡åã€‚</li>
<li>ç”±æ­¤å¯è§ï¼Œ<strong>selector ä¸­ä¸å¿…åŒ…å« metric_name</strong>ã€‚</li>
<li>å› æ­¤ï¼Œè¯¥è¡¨è¾¾å¼å’Œå‰ä¸€ä¸ªä¾‹å­ç­‰ä»·ã€‚</li>
</ul>
</li>
<li><code>http_requests_total{api=~"v1.*", code!~"20[0-9]", method!="POST"}</code><ul>
<li><code>=</code> è¡¨ç¤ºç²¾ç¡®åŒ¹é…ï¼Œ<code>=~</code> è¡¨ç¤ºæ­£åˆ™åŒ¹é…ï¼Œ<code>!=</code> å’Œ <code>!~</code> è¡¨ç¤ºä¸åŒ¹é…ï¼Œåˆ†åˆ«é€‚ç”¨äºå­—ç¬¦ä¸²å’Œæ­£åˆ™è¡¨è¾¾å¼ã€‚</li>
<li>æ­£åˆ™è¡¨è¾¾å¼æ˜¯ fully anchored çš„ï¼Œå³ <code>api=~"v1.*"</code> ç­‰ä»·äº <code>api=~"^v1.*$"</code>ã€‚</li>
</ul>
</li>
<li><code>http_requests_total offset 5m</code> / <code>http_requests_total{method="GET"} offset 5m</code><ul>
<li><code>offset</code> ç”¨äºæŒ‡å®šæ—¶é—´åç§»é‡ï¼Œä¾‹å¦‚ <code>offset 5m</code> è¡¨ç¤ºå‘å‰åç§» 5 åˆ†é’Ÿã€‚</li>
</ul>
</li>
<li><code>http_requests_total @ 1609746000</code> / <code>http_requests_total{method="GET"} @ 1609746000</code><ul>
<li><code>@</code> ç”¨äºæŒ‡å®šæ—¶é—´æˆ³ï¼Œä¾‹å¦‚ <code>@ 1609746000</code> è¡¨ç¤ºåœ¨æ—¶é—´æˆ³ 1609746000 çš„æ—¶å€™çš„å€¼ã€‚</li>
</ul>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title">å“ªäº› time series ä¼šè¢«åŒ…å«åœ¨æŸ¥è¯¢ç»“æœä¸­ï¼Ÿ</p>
<p>Prometheus é…ç½®äº†ä¸€ä¸ª <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/#staleness">staleness</a> æ—¶é•¿ï¼Œé»˜è®¤å€¼æ˜¯ 5 åˆ†é’Ÿã€‚</p>
<p>åœ¨ä½¿ç”¨ Instant Vector Selector æ—¶ï¼Œåœ¨æŸ¥è¯¢æ—¶é—´ç‚¹å‰ staleness æ—¶é•¿çš„èŒƒå›´å†…å‡ºç°è¿‡æ•°æ®çš„æ‰€æœ‰ time series ä¼šè¢«åŒ…å«åœ¨ç»“æœçš„ <code>InstantVector</code> ä¸­ï¼›å…¶å€¼æ˜¯è¯¥èŒƒå›´å†…æœ€åä¸€æ¬¡é‡‡æ ·åˆ°çš„å€¼ã€‚</p>
</div>
<p>ä»¥ä¸‹è¡¨è¾¾å¼å…·æœ‰ç±»å‹ <code>RangeVector</code>ï¼š</p>
<ul>
<li><code>http_requests_total[5m]</code></li>
<li><code>http_requests_total{method="GET"}[5m]</code></li>
<li><code>http_requests_total{method="GET"}[5m] offset 5m</code></li>
<li><code>http_requests_total{method="GET"}[5m] @ 1609746000</code></li>
</ul>
<div class="admonition info">
<p class="admonition-title">å“ªäº› time series ä¼šè¢«åŒ…å«åœ¨æŸ¥è¯¢ç»“æœä¸­ï¼Ÿ</p>
<p>å¯¹äº Range Vector Selectorï¼ŒPrometheus ä¼šè¿”å›åœ¨æŸ¥è¯¢æ—¶é—´å†…å‡ºç°è¿‡æ•°æ®çš„æ‰€æœ‰ time seriesï¼›å…¶å€¼æ˜¯åœ¨æŸ¥è¯¢æ—¶é—´èŒƒå›´å†…æ¯ä¸ªæ—¶é—´ç‚¹çš„å€¼ã€‚</p>
</div>
<h3 id="23-operators--è¿ç®—ç¬¦">2.3 Operators | è¿ç®—ç¬¦<a class="headerlink" href="#23-operators--è¿ç®—ç¬¦" title="Permanent link">&para;</a></h3>
<h4 id="231-ç®—æœ¯äºŒå…ƒè¿ç®—ç¬¦">2.3.1 ç®—æœ¯äºŒå…ƒè¿ç®—ç¬¦<a class="headerlink" href="#231-ç®—æœ¯äºŒå…ƒè¿ç®—ç¬¦" title="Permanent link">&para;</a></h4>
<p>åŒ…æ‹¬ <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%</code> (å–æ¨¡), <code>^</code> (å¹‚)ã€‚å…¶è¡Œä¸ºæ˜¯ï¼š</p>
<ul>
<li><code>Scalar &lt;op&gt; Scalar</code>ï¼šå’Œæ­£å¸¸ç®—æœ¯ä¸€è‡´ï¼›</li>
<li><code>InstantVector &lt;op&gt; Scalar</code>ï¼šè¿”å›å¯¹ InstantVector ä¸­çš„æ¯ä¸ªå…ƒç´ åº”ç”¨ <code>&lt;op&gt;</code> çš„ç»“æœï¼›<strong>metric_name (<code>__name__</code>) è¢«åˆ é™¤</strong>ï¼›</li>
<li><code>InstantVector1 &lt;op&gt; InstantVector2</code>ï¼šå¯¹äº InstantVector1 ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œåœ¨ InstantVector2 ä¸­æ‰¾åˆ°æ ‡ç­¾å®Œå…¨ç›¸åŒçš„å…ƒç´ ï¼Œå°†å…¶åº”ç”¨ <code>&lt;op&gt;</code> çš„ç»“æœè¿”å›ï¼Œ<strong>metric_name (<code>__name__</code>) è¢«åˆ é™¤</strong>ï¼›å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ™ç»“æœä¸­ä¸åŒ…å«è¯¥ labelï¼›</li>
<li>ä¸æ¥å— RangeVectorã€‚</li>
</ul>
<h4 id="232-æ¯”è¾ƒäºŒå…ƒè¿ç®—ç¬¦">2.3.2 æ¯”è¾ƒäºŒå…ƒè¿ç®—ç¬¦<a class="headerlink" href="#232-æ¯”è¾ƒäºŒå…ƒè¿ç®—ç¬¦" title="Permanent link">&para;</a></h4>
<p>åŒ…æ‹¬ <code>==</code>, <code>!=</code>, <code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code>ã€‚å…¶è¡Œä¸ºæ˜¯ï¼š</p>
<ul>
<li><code>bool(Scalar &lt;op&gt; Scalar)</code>ï¼šè¿”å› 0 æˆ–è€… 1ï¼›</li>
<li><code>InstantVector &lt;op&gt; Scalar</code>ï¼šè¿”å›ç»“æœä¸­æ¯”è¾ƒç»“æœä¸ºçœŸçš„å…ƒç´ ä¿ç•™ï¼Œå…¶ä½™åˆ é™¤ï¼›</li>
<li><code>bool(InstantVector &lt;op&gt; Scalar)</code>ï¼šè¿”å›ç»“æœä¸­å°†æ¯”è¾ƒç»“æœä¸ºçœŸçš„å…ƒç´ ç½®ä¸º 1ï¼Œå…¶ä½™ç½®ä¸º 0ï¼›<strong>metric_name (<code>__name__</code>) è¢«åˆ é™¤</strong>ï¼›</li>
<li><code>InstantVector1 &lt;op&gt; InstantVector2</code>ï¼šInstantVector2 ä½œä¸ºè¿‡æ»¤å™¨ï¼šInstantVector1 åœ¨å…¶ä¸­æ‰¾ä¸åˆ°æ ‡ç­¾å®Œå…¨ç›¸åŒçš„å…ƒç´ ï¼Œæˆ–è€…å¯¹åº”å…ƒç´ æ¯”è¾ƒç»“æœä¸ºå‡çš„ï¼Œå°†å…¶åˆ é™¤ï¼›</li>
<li><code>bool(InstantVector1 &lt;op&gt; InstantVector2)</code>ï¼šç±»ä¼¼å‰ä¸€æ¡ï¼šä¿ç•™çš„å…ƒç´ ç½®ä¸º 1ï¼Œå…¶ä½™ç½®ä¸º 0ï¼›<strong>metric_name (<code>__name__</code>) è¢«åˆ é™¤</strong>ï¼›</li>
<li>ä¸æ¥å— RangeVectorã€‚</li>
</ul>
<h4 id="233-é€»è¾‘é›†åˆäºŒå…ƒè¿ç®—ç¬¦">2.3.3 é€»è¾‘ï¼ˆé›†åˆï¼‰äºŒå…ƒè¿ç®—ç¬¦<a class="headerlink" href="#233-é€»è¾‘é›†åˆäºŒå…ƒè¿ç®—ç¬¦" title="Permanent link">&para;</a></h4>
<p>åŒ…æ‹¬ <code>and</code>, <code>or</code>, <code>unless</code>ï¼Œåªåœ¨ <code>InstantVector</code> ä¹‹é—´å®šä¹‰ã€‚å…¶è¡Œä¸ºæ˜¯ï¼š</p>
<ul>
<li><code>iv1 and iv2</code> (intersection)ï¼šè¿”å› iv1 ä¸­çš„é‚£äº›åœ¨ iv2 ä¸­å…·æœ‰å®Œå…¨ç›¸åŒæ ‡ç­¾çš„å…ƒç´ ï¼›</li>
<li><code>iv1 or iv2</code> (union)ï¼šè¿”å› iv1 çš„æ‰€æœ‰å…ƒç´ ï¼Œä»¥åŠ iv2 ä¸­é‚£äº›åœ¨ iv1 ä¸­æ²¡æœ‰å®Œå…¨ç›¸åŒæ ‡ç­¾é›†çš„å…ƒç´ ï¼›</li>
<li><code>iv1 unless iv2</code> (complement)ï¼šè¿”å› iv1 ä¸­çš„é‚£äº›åœ¨ iv2 ä¸­æ²¡æœ‰å®Œå…¨ç›¸åŒæ ‡ç­¾çš„å…ƒç´ ã€‚</li>
</ul>
<h4 id="234-vector-matching">2.3.4 Vector Matching<a class="headerlink" href="#234-vector-matching" title="Permanent link">&para;</a></h4>
<p>ä¸Šé¢ä¸‰èŠ‚ä¸­æè¿°çš„ <code>InstantVector</code> ä¹‹é—´çš„æ“ä½œï¼Œéƒ½è¯•å›¾ä»å³è¾¹çš„ <code>InstantVector</code> ä¸­ä¸ºå·¦è¾¹çš„ <code>InstantVector</code> ä¸­çš„æ¯ä¸ªå…ƒç´ æ‰¾åˆ°æ ‡ç­¾åŒ¹é…çš„å…ƒç´ ã€‚è¿™ä¸ªã€ŒåŒ¹é…ã€è¿‡ç¨‹ä¹Ÿæ˜¯å¯ä»¥æ§åˆ¶çš„ï¼š</p>
<ul>
<li><code>iv1 &lt;bin-op&gt; on(&lt;label-list&gt;) iv2</code> å°†çº³å…¥è€ƒè™‘çš„æ ‡ç­¾é™åˆ¶åœ¨ <code>&lt;label-list&gt;</code> ä¸­ï¼Œå…¶ä»–æ ‡ç­¾å…¨éƒ¨å¿½ç•¥ï¼›</li>
<li><code>iv1 &lt;bin-op&gt; ignoring(&lt;label-list&gt;) iv2</code> å°†å¿½ç•¥ <code>&lt;label-list&gt;</code> ä¸­çš„æ ‡ç­¾ï¼Œå…¶ä»–æ ‡ç­¾å…¨éƒ¨çº³å…¥è€ƒè™‘ã€‚</li>
</ul>
<p>ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªä¾‹å­ï¼š</p>
<p><img alt="" src="../topics/assets/2024-07-09-19-48-45.png" /></p>
<p>å¦å¤–åœ¨ç®—æœ¯å’Œæ¯”è¾ƒè¿ç®—ç¬¦ä¸­ï¼Œè¿˜å¯ä»¥é€šè¿‡ <code>group_left</code> å’Œ <code>group_right</code> å®ç°ä¸€å¯¹å¤šå’Œå¤šå¯¹ä¸€çš„åŒ¹é…ã€‚æœ¬æ–‡æš‚ä¸”ç•¥å»ï¼Œå‚è§ <a href="https://prometheus.io/docs/prometheus/latest/querying/operators/#many-to-one-and-one-to-many-vector-matches">æ–‡æ¡£</a>ã€‚</p>
<h4 id="235-èšåˆè¿ç®—ç¬¦">2.3.5 èšåˆè¿ç®—ç¬¦<a class="headerlink" href="#235-èšåˆè¿ç®—ç¬¦" title="Permanent link">&para;</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>é™¤äº† <code>topk</code> å’Œ <code>bottomk</code> ä»¥å¤–ï¼Œæ‰€æœ‰èšåˆè¿ç®—ç¬¦éƒ½ä¼šåœ¨ç»“æœä¸­åˆ é™¤ metrics name (<code>__name__</code>)ï¼Œå› ä¸ºæ‰€å¾—çš„å€¼ç»è¿‡äº†å¤„ç†ï¼Œè€ŒåŸæ¥ metrics name ä¸å†æœ‰æ„ä¹‰ã€‚</p>
</div>
<p>èšåˆè¿ç®—ç¬¦å°† InstantVector æŒ‰ç…§æ ‡ç­¾èšåˆä¸ºå…ƒç´ æ›´å°‘çš„ InstantVectorã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li><code>sum(http_requests_total)</code>ï¼šè¿”å›ä¸€ä¸ªå•å…ƒç´ çš„ InstantVectorï¼Œæ ‡ç­¾ä¸º <code>{}</code>ï¼Œå€¼ä¸ºæ‰€æœ‰ <code>http_requests_total</code> çš„å’Œï¼›</li>
<li><code>sum(http_requests_total{method="GET"})</code>ï¼šè¿”å›ä¸€ä¸ªå•å…ƒç´ çš„ InstantVectorï¼Œæ ‡ç­¾ä¸º <code>{}</code>ï¼Œå€¼ä¸ºæ‰€æœ‰ <code>http_requests_total{method="GET"}</code> çš„å’Œï¼›</li>
<li><code>sum(http_requests_total) by (method)</code>ï¼šè¿”å›ä¸€ä¸ª InstantVectorï¼›å¯¹äº <code>http_requests_total</code> ä¸­çš„æ¯ä¸ªä¸åŒçš„ <code>method</code>ï¼Œè¿”å›ä¸€ä¸ªå…ƒç´ ï¼Œæ ‡ç­¾åªæœ‰ <code>method</code>ï¼Œå€¼ä¸ºæ‰€æœ‰å¯¹åº” method çš„ <code>http_requests_total</code> çš„å’Œï¼›</li>
<li><code>sum(http_requests_total) by (method, code)</code>ï¼šç±»ä¼¼ï¼Œå¯¹äº <code>(method, code)</code> çš„æ¯ç§å­˜åœ¨çš„ç»„åˆï¼Œè¿”å›ä¸€ä¸ªå…ƒç´ ã€‚</li>
<li><code>sum(http_requests_total) without (method)</code>ï¼šä¸ <code>by</code> ç›¸åï¼šå¯¹äºé™¤äº† <code>method</code> ä»¥å¤–çš„æ‰€æœ‰æ ‡ç­¾çš„æ¯ç§å­˜åœ¨ç»„åˆï¼Œè¿”å›ä¸€ä¸ªå…ƒç´ ã€‚<ul>
<li>ä¾‹å¦‚ï¼Œæ ‡ç­¾åªæœ‰ <code>method, code, api</code> çš„è¯ï¼Œé‚£ä¹ˆ <code>by (method)</code> å’Œ <code>without (code, api)</code> ç­‰ä»·ã€‚</li>
</ul>
</li>
</ul>
<p>ä»¥ä¸Šçš„ <code>without</code> å’Œ <code>by</code> ä¸èƒ½å…±ç”¨ï¼›å¦å¤– <code>sum(v) by (&lt;labels&gt;)</code> å’Œ <code>sum by (&lt;labels&gt;) (v)</code> æ˜¯ç­‰ä»·çš„ã€‚</p>
<p>å³ï¼šæˆ‘ä»¬é€šè¿‡ <code>by</code> æˆ–è€… <code>without</code> å°† InstantVector æŒ‰ç…§æ ‡ç­¾ <strong>åˆ†ç»„</strong>ï¼Œç„¶åå®Œæˆèšåˆæ“ä½œï¼›å¦‚æœæ²¡æœ‰æŒ‡å®šåˆ†ç»„ï¼Œåˆ™è®¤ä¸ºæ‰€æœ‰æ ‡ç­¾å±äºä¸€ç»„ã€‚è¿™æ ·çš„èšåˆè¿ç®—ç¬¦åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>sum</code>: æ¯ç»„ä¸­æ‰€æœ‰å…ƒç´ çš„å’Œï¼›</li>
<li><code>max</code>, <code>min</code>, <code>avg</code>, <code>stddev</code>, <code>stdvar</code>: åˆ†åˆ«æ˜¯æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€æ ‡å‡†å·®ã€æ–¹å·®ï¼›</li>
<li><code>group</code>: ç»“æœä¸­çš„å€¼å…¨éƒ¨ä¸º 1ï¼›</li>
<li><code>count</code>: æ¯ç»„ä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚</li>
</ul>
<p>å¦å¤–ï¼Œè¿˜æœ‰ä¸€äº›èšåˆå‡½æ•°å«æœ‰å‚æ•°ï¼Œå…¶ä½¿ç”¨æ–¹æ³•å½¢å¦‚ <code>count_values("api", http_requests_total) by (code)</code>ï¼Œè¡¨ç¤ºå¯¹äºæ¯ä¸ª <code>code</code>ï¼Œç»Ÿè®¡ label <code>api</code> çš„ä¸åŒå€¼çš„ä¸ªæ•°ã€‚è¿™æ ·çš„èšåˆè¿ç®—ç¬¦åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>count_values(label, v)</code>: å¯¹äºæ¯ä¸ªç»„ï¼Œç»Ÿè®¡ label çš„ä¸åŒå€¼çš„ä¸ªæ•°ï¼›</li>
<li><code>quantile(Ï†, v)</code>: å¯¹äºæ¯ä¸ªç»„ï¼Œè®¡ç®—å…¶ä¸­æ‰€æœ‰å€¼ä¸­ Ï† åˆ†ä½çš„å€¼ã€‚</li>
</ul>
<p>ä¸ä¸Šè¿°ä¸åŒçš„ä¸¤ä¸ªèšåˆè¿ç®—ç¬¦æ˜¯ <code>topk</code> å’Œ <code>bottomk</code>ï¼Œå®ƒä»¬ä¿ç•™æ¯ç»„ä¸­çš„å‰ k ä¸ªæˆ–å k ä¸ªå…ƒç´ ã€‚</p>
<h3 id="24-functions--å‡½æ•°">2.4 Functions | å‡½æ•°<a class="headerlink" href="#24-functions--å‡½æ•°" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>è¯·æ³¨æ„ï¼šå‡ ä¹æ‰€æœ‰çš„å‡½æ•° (é™¤äº† <code>sort</code>, <code>sort_desc</code>, <code>label_replace</code>) éƒ½ä¼šåœ¨ç»“æœä¸­åˆ é™¤ metrics name (<code>__name__</code>)ï¼Œå› ä¸ºæ‰€å¾—çš„å€¼ç»è¿‡äº†å¤„ç†ï¼Œè€ŒåŸæ¥ metrics name ä¸å†æœ‰æ„ä¹‰ã€‚</p>
</div>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>IV</code> å’Œ <code>RV</code> åˆ†åˆ«æ›¿ä»£ <code>InstantVector</code> å’Œ <code>RangeVector</code>ã€‚</p>
<h4 id="æ•°å­¦è¿ç®—">æ•°å­¦è¿ç®—<a class="headerlink" href="#æ•°å­¦è¿ç®—" title="Permanent link">&para;</a></h4>
<ul>
<li>ã€ç»å¯¹å€¼ã€‘<code>abs(v: IV) -&gt; IV</code>: ç»“æœä¸­æ¯ä¸ªå…ƒç´ çš„å€¼æ˜¯åŸæ¥å…ƒç´ çš„ç»å¯¹å€¼ã€‚</li>
<li>ã€ç¬¦å·å‡½æ•°ã€‘<code>sgn(v: IV) -&gt; IV</code>: ç»“æœä¸­æ¯ä¸ªå…ƒç´ çš„å€¼æ˜¯åŸæ¥å…ƒç´ çš„æ­£è´Ÿæ€§ï¼Œå³ 1ã€0ã€-1ã€‚</li>
<li>ã€å‘ä¸Šå–æ•´ã€‘<code>ceil(v: IV) -&gt; IV</code>: ç»“æœä¸­æ¯ä¸ªå…ƒç´ çš„å€¼æ˜¯åŸæ¥å…ƒç´ çš„å‘ä¸Šå–æ•´ã€‚</li>
<li>ã€å‘ä¸‹å–æ•´ã€‘<code>floor(v: IV) -&gt; IV</code>: ç»“æœä¸­æ¯ä¸ªå…ƒç´ çš„å€¼æ˜¯åŸæ¥å…ƒç´ çš„å‘ä¸‹å–æ•´ã€‚</li>
<li>ã€å››èˆäº”å…¥ã€‘<code>round(v: IV, to_nearest: Scalar = 1) -&gt; IV</code>: ç»“æœä¸­æ¯ä¸ªå…ƒç´ çš„å€¼æ˜¯åŸæ¥å…ƒç´ çš„å››èˆäº”å…¥å€¼ï¼Œå–åˆ°æœ€æ¥è¿‘çš„ <code>to_nearest</code> çš„å€æ•°ï¼›<code>to_nearest</code> å¯ä»¥æ˜¯åˆ†æ•°ã€‚</li>
<li>ã€æŒ‡æ•°ã€‘<code>exp(v: IV) -&gt; IV</code>: ç»“æœä¸­æ¯ä¸ªå…ƒç´ çš„å€¼æ˜¯åŸæ¥å…ƒç´ çš„æŒ‡æ•° <span class="arithmatex">\(e^x\)</span>ã€‚</li>
<li>ã€è‡ªç„¶å¯¹æ•°ã€‘<code>ln(v: IV) -&gt; IV</code>: ç»“æœä¸­æ¯ä¸ªå…ƒç´ çš„å€¼æ˜¯åŸæ¥å…ƒç´ çš„è‡ªç„¶å¯¹æ•° <span class="arithmatex">\(\ln(x)\)</span>ã€‚</li>
<li>ã€å¯¹æ•°ã€‘<code>log2(v: IV) -&gt; IV</code>, <code>log10(v: IV) -&gt; IV</code>: ç»“æœä¸­æ¯ä¸ªå…ƒç´ çš„å€¼æ˜¯åŸæ¥å…ƒç´ çš„å¯¹æ•°ã€‚</li>
<li>ã€å¹³æ–¹æ ¹ã€‘<code>sqrt(v: IV) -&gt; IV</code>: ç»“æœä¸­æ¯ä¸ªå…ƒç´ çš„å€¼æ˜¯åŸæ¥å…ƒç´ çš„å¹³æ–¹æ ¹ã€‚</li>
<li>ã€ä¸‰è§’å‡½æ•°ã€‘å¦å¤–è¿˜æœ‰è¿™äº›ä¸‰è§’å‡½æ•°ï¼Œå’Œä¸Šè¿°ç±»ä¼¼ï¼š<code>sin</code>, <code>cos</code>, <code>tan</code>, <code>asin</code>, <code>acos</code>, <code>atan</code>, <code>sinh</code>, <code>cosh</code>, <code>tanh</code>, <code>asinh</code>, <code>acosh</code>, <code>atanh</code>ã€‚</li>
<li>ã€è§’åº¦å’Œå¼§åº¦ã€‘<code>deg(v: IV) -&gt; IV</code>, <code>rad(v: IV) -&gt; IV</code>: å°†è§’åº¦å’Œå¼§åº¦ç›¸äº’è½¬æ¢ã€‚</li>
<li>ã€<span class="arithmatex">\(\pi\)</span>ã€‘<code>pi() -&gt; Scalar</code> è¿”å› <span class="arithmatex">\(\pi\)</span>ã€‚</li>
</ul>
<h4 id="æ—¶é—´">æ—¶é—´<a class="headerlink" href="#æ—¶é—´" title="Permanent link">&para;</a></h4>
<ul>
<li>ã€æ±‚å€¼æ—¶çš„æ—¶é—´ã€‘<code>time() -&gt; Scalar</code>: è¿”å›è®¡ç®—è¡¨è¾¾å¼æ—¶çš„æ—¶é—´æˆ³ï¼Œå³è‡ª UTC 1970 å¹´ 1 æœˆ 1 æ—¥ä»¥æ¥çš„ç§’æ•°ã€‚</li>
<li>ã€æ—¶é—´æˆ³ã€‘<code>timestamp(v: IV) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„æ—¶é—´æˆ³ã€‚</li>
<li><code>day_of_month(v: IV = vector(time())) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„æ—¶é—´æˆ³åœ¨æ‰€åœ¨æœˆçš„ç¬¬å‡ å¤©ã€‚<ul>
<li>ç±»ä¼¼åœ°ï¼Œè¿˜æœ‰ <code>day_of_week</code>, <code>day_of_year</code></li>
</ul>
</li>
<li><code>hour(v: IV = vector(time())) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„æ—¶é—´æˆ³çš„åœ¨æ‰€åœ¨å¤©ä¸­çš„å°æ—¶ (0-23)ã€‚<ul>
<li>ç±»ä¼¼åœ°ï¼Œè¿˜æœ‰ <code>minute</code>, <code>year</code>, <code>month</code></li>
</ul>
</li>
<li><code>days_in_month(v: IV = vector(time())) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„æ—¶é—´æˆ³å¯¹åº”çš„æœˆä»½ä¸­æœ‰å‡ å¤©ã€‚</li>
</ul>
<h4 id="åˆ¤æ–­æ˜¯å¦ä¸ºç©º">åˆ¤æ–­æ˜¯å¦ä¸ºç©º<a class="headerlink" href="#åˆ¤æ–­æ˜¯å¦ä¸ºç©º" title="Permanent link">&para;</a></h4>
<ul>
<li><code>absent(v: IV) -&gt; IV</code>: å¦‚æœ v æœ‰ä»»ä½•å…ƒç´ ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©º vectorï¼›å¦åˆ™è¿”å›ä¸€ä¸ªå€¼ä¸º 1 çš„å•å…ƒç´  vectorï¼Œlabel ä¸º v ä¸­å„å…ƒç´  label çš„å…±åŒéƒ¨åˆ†ã€‚<ul>
<li>ç”¨ä¾‹ï¼šæŸ¥è¯¢æ˜¯å¦æœ‰ 500 é”™è¯¯ï¼š<code>absent(http_requests_total{code="500"})</code></li>
</ul>
</li>
<li><code>absent_over_time(v: RV) -&gt; IV</code>: å¦‚æœ v åœ¨æ—¶é—´èŒƒå›´å†…æœ‰ä»»ä½•å…ƒç´ ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©º vectorï¼›å¦åˆ™è¿”å›ä¸€ä¸ªå€¼ä¸º 1 çš„å•å…ƒç´  vectorï¼Œlabel ä¸º v ä¸­å„å…ƒç´  label çš„å…±åŒéƒ¨åˆ†<ul>
<li>ç”¨ä¾‹ï¼šæŸ¥è¯¢æœ€è¿‘ 5 åˆ†é’Ÿæ˜¯å¦æœ‰ 500 é”™è¯¯ï¼š<code>absent_over_time(http_requests_total{code="500"}[5m])</code></li>
</ul>
</li>
</ul>
<h4 id="é™åˆ¶æ ·æœ¬å€¼">é™åˆ¶æ ·æœ¬å€¼<a class="headerlink" href="#é™åˆ¶æ ·æœ¬å€¼" title="Permanent link">&para;</a></h4>
<ul>
<li><code>clamp(v: IV, min: Scalar, max: Scalar) -&gt; IV</code>: ç»“æœä¸­æ¯ä¸ªå…ƒç´ çš„å€¼å¦‚æœå°äº minï¼Œåˆ™å– minï¼›å¦‚æœå¤§äº maxï¼Œåˆ™å– maxï¼›å¦åˆ™ä¿æŒä¸å˜ã€‚<ul>
<li>ç‰¹åˆ«åœ°ï¼šå¦‚æœ min &gt; maxï¼Œåˆ™è¿”å›ä¸€ä¸ªç©º vectorï¼›å¦‚æœ min æˆ– max æ˜¯ NaNï¼Œåˆ™ç»“æœä¸º NaNã€‚</li>
</ul>
</li>
<li><code>clamp_max(v: IV, max: Scalar) -&gt; IV</code>, <code>clamp_min(v: IV, min: Scalar) -&gt; IV</code>: ä¸å‰ä¸€æ¡ç±»ä¼¼ã€‚</li>
</ul>
<h4 id="å˜åŒ–æƒ…å†µ">å˜åŒ–æƒ…å†µ<a class="headerlink" href="#å˜åŒ–æƒ…å†µ" title="Permanent link">&para;</a></h4>
<ul>
<li>ã€å˜åŒ–æ¬¡æ•°ã€‘<code>changes(v: RV) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„å˜åŒ–æ¬¡æ•°ã€‚<ul>
<li>ç”¨ä¾‹ï¼šæŸ¥è¯¢æœ€è¿‘ 5 åˆ†é’Ÿ 500 é”™è¯¯çš„å˜åŒ–æ¬¡æ•°ï¼š<code>changes(http_requests_total{code="500"}[5m])</code></li>
</ul>
</li>
<li>ã€å·®å€¼ã€‘<code>delta(v: RV) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„æœ€åä¸¤ä¸ªæ ·æœ¬å€¼çš„å·®å€¼ã€‚<ul>
<li>ç”¨ä¾‹ï¼šæŸ¥è¯¢æœ€è¿‘ 5 åˆ†é’Ÿ 500 é”™è¯¯çš„å·®å€¼ï¼š<code>delta(http_requests_total{code="500"}[5m])</code></li>
<li>ç»“æœå¯èƒ½æ˜¯éæ•´æ•°ï¼Œå› ä¸ºå¿…è¦æ—¶ä¼šè¿›è¡Œæ’å€¼ã€‚</li>
</ul>
</li>
<li>ã€å¢é‡ã€‘<code>increase(v: RV) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„å¢é‡ã€‚è¿™åªåº”è¢«ç”¨äº Counter ç±»å‹çš„æŒ‡æ ‡ (ä½†å¹¶ä¸ä¼šæ£€æŸ¥)ã€‚<ul>
<li>å®ƒå’Œ <code>delta</code> çš„åŒºåˆ«åœ¨äºï¼šå¦‚æœæ—¶é—´èŒƒå›´å†…æŒ‡æ ‡å› ä¸ºé‡å¯æˆ–è€…å…¶ä»–åŸå› è€Œç ´åäº†å•è°ƒæ€§ï¼Œ<code>increase</code> ä¼šåŠ ä»¥è¡¥å¿ï¼Œä¾‹å¦‚ <code>0 -&gt; 10 -&gt; 2 -&gt; 15</code> ä¼šè¢«è¡¥å¿ä¸º <code>0 -&gt; 10 -&gt; 12 -&gt; 25</code>ã€‚</li>
<li>ç”¨ä¾‹ï¼šæŸ¥è¯¢æœ€è¿‘ 5 åˆ†é’Ÿ 500 é”™è¯¯çš„å¢é‡ï¼š<code>increase(http_requests_total{code="500"}[5m])</code></li>
</ul>
</li>
<li>ã€ç¬æ—¶å·®å€¼ã€‘<code>idelta(v: RV) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„æœ€åä¸¤ä¸ªæ ·æœ¬å€¼çš„å·®å€¼ã€‚è¿™åªåº”è¢«ç”¨äº Gauge ç±»å‹çš„æŒ‡æ ‡ (ä½†å¹¶ä¸ä¼šæ£€æŸ¥)ã€‚</li>
<li>ã€å¯¼æ•°ã€‘<code>deriv(v: RV) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—ç”¨ <a href="https://en.wikipedia.org/wiki/Simple_linear_regression">ç®€å•çº¿æ€§å›å½’</a> è®¡ç®—å‡ºå¯¼æ•°ã€‚è¿™åªåº”è¢«ç”¨äº Gauge ç±»å‹çš„æŒ‡æ ‡ (ä½†å¹¶ä¸ä¼šæ£€æŸ¥)ã€‚<ul>
<li>ç”¨ä¾‹ï¼šæŸ¥è¯¢æœ€è¿‘ 5 åˆ†é’Ÿ 500 é”™è¯¯çš„å˜åŒ–ç‡ï¼š<code>deriv(http_requests_total{code="500"}[5m])</code></li>
</ul>
</li>
<li>ã€Smoothingã€‘<code>holt_winters(v: RV, sf: Scalar, tf: Scalar) -&gt; IV</code>: ä½¿ç”¨ Holt-Winters æŒ‡æ•°å¹³æ»‘ç®—æ³•å¯¹ v è¿›è¡Œå¹³æ»‘å¤„ç†ã€‚sf å’Œ tf åˆ†åˆ«æ˜¯å¹³æ»‘å› å­å’Œæ—¶é—´å› å­ã€‚</li>
<li>ã€å¢é•¿ç‡ã€‘<code>rate(v: RV) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„å¢é•¿ç‡ã€‚è¿™åªåº”è¢«ç”¨äº Counter ç±»å‹çš„æŒ‡æ ‡ã€‚å¦‚æœæ—¶é—´èŒƒå›´å†…æŒ‡æ ‡å› ä¸ºé‡å¯æˆ–è€…å…¶ä»–åŸå› è€Œç ´åäº†å•è°ƒæ€§ï¼Œä¼šåŠ ä»¥è¡¥å¿ã€‚<ul>
<li>ç”¨ä¾‹ï¼šæŸ¥è¯¢æœ€è¿‘ 5 åˆ†é’Ÿ 500 é”™è¯¯çš„å¢é•¿ç‡ï¼š<code>rate(http_requests_total{code="500"}[5m])</code></li>
</ul>
</li>
<li>ã€ç¬æ—¶å¢é•¿ç‡ã€‘<code>irate(v: RV) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—åŸºäºæœ€åä¸¤ä¸ªæ ·æœ¬å€¼è®¡ç®—å‡ºçš„ç¬æ—¶å¢é•¿ç‡ã€‚è¿™åªåº”è¢«ç”¨äºç»˜åˆ¶ä¸ç¨³å®šçš„ã€å¿«é€Ÿå¢é•¿çš„ countersã€‚å¦‚æœæ—¶é—´èŒƒå›´å†…æŒ‡æ ‡å› ä¸ºé‡å¯æˆ–è€…å…¶ä»–åŸå› è€Œç ´åäº†å•è°ƒæ€§ï¼Œä¼šåŠ ä»¥è¡¥å¿ã€‚</li>
<li>ã€çº¿æ€§é¢„æµ‹ã€‘<code>predict_linear(v: RV, t: Scalar) -&gt; IV</code>: åŸºäº <a href="https://en.wikipedia.org/wiki/Simple_linear_regression">ç®€å•çº¿æ€§å›å½’</a>ï¼Œé¢„æµ‹ v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—åœ¨ t ç§’åçš„å€¼ã€‚</li>
<li>ã€é‡ç½®æ¬¡æ•°ã€‘<code>resets(v: RV) -&gt; IV</code>: è¿”å› v ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„é‡ç½®æ¬¡æ•°ï¼ˆä¸¤æ¬¡è¿ç»­é‡‡æ ·ä¸­çš„ä»»ä½•å‡å°‘éƒ½è¢«è®¤ä¸ºæ˜¯é‡ç½®ï¼‰ã€‚è¿™åªåº”è¢«ç”¨äº Counter ç±»å‹çš„æŒ‡æ ‡ã€‚</li>
</ul>
<h4 id="æ ‡ç­¾æ“ä½œ">æ ‡ç­¾æ“ä½œ<a class="headerlink" href="#æ ‡ç­¾æ“ä½œ" title="Permanent link">&para;</a></h4>
<ul>
<li>ã€æ ‡ç­¾æ›¿æ¢ã€‘<code>label_replace(v: IV, dst_label: String, replacement: String, src_label: String, regex: String) -&gt; IV</code>: å¯¹äº v ä¸­çš„æ¯ä¸ª time seriesï¼Œå¦‚æœå…¶æ ‡ç­¾ <code>src_label</code> çš„å€¼åŒ¹é… <code>regex</code>ï¼Œåˆ™å°†å…¶æ›¿æ¢ä¸º <code>replacement</code>ï¼Œæ”¾åˆ° <code>dst_label</code> ä¸­ï¼›å¦‚æœä¸åŒ¹é…ï¼Œåˆ™ä¿æŒä¸å˜ã€‚<code>replacement</code> ä¸­å¯ä»¥ä½¿ç”¨ <code>$1</code>, <code>$2</code>, ... æ¥å¼•ç”¨ <code>regex</code> ä¸­çš„åˆ†ç»„ã€‚<ul>
<li>ä¾‹å¦‚ï¼Œ<code>label_replace(http_requests_total{method="GET"}, "new_label", "$1", "api", "(.*)/.*")</code> ä¼šå°† <code>http_requests_total{api="a/b"}</code> è½¬æ¢ä¸º <code>http_requests_total{new_label="a"}</code>ã€‚</li>
</ul>
</li>
<li>ã€æ ‡ç­¾è¿æ¥ã€‘<code>label_join(v: IV, dst_label: String, separator: String, src_label_1: String, src_label_2: String, ...) -&gt; IV</code>: å°† v ä¸­çš„æ ‡ç­¾ src_label_1, src_label_2, ... çš„å€¼è¿æ¥èµ·æ¥ï¼Œç”¨ separator åˆ†éš”ï¼Œæ”¾åˆ° dst_label ä¸­ã€‚<ul>
<li>ä¾‹å¦‚ï¼Œ<code>label_join(http_requests_total{method="GET"}, "new_label", "-", "method", "code")</code> ä¼šå°† <code>http_requests_total{method="GET", code="200"}</code> è½¬æ¢ä¸º <code>http_requests_total{new_label="GET-200"}</code>ã€‚</li>
</ul>
</li>
</ul>
<h4 id="ç±»å‹è½¬æ¢">ç±»å‹è½¬æ¢<a class="headerlink" href="#ç±»å‹è½¬æ¢" title="Permanent link">&para;</a></h4>
<ul>
<li>ã€ç±»å‹è½¬æ¢ã€‘<code>scalar(v: IV) -&gt; Scalar</code>: å¦‚æœ v æ°æœ‰ 1 ä¸ªæ—¶é—´åºåˆ—ï¼Œè¿”å›å…¶å€¼ï¼›å¦åˆ™è¿”å› NaNã€‚</li>
<li>ã€ç±»å‹è½¬æ¢ã€‘<code>vector(s: Scalar) -&gt; IV</code>: å°† s è½¬æ¢ä¸ºä¸€ä¸ªæ—¶é—´åºåˆ—ï¼Œå…¶å€¼ä¸º sï¼Œæ²¡æœ‰æ ‡ç­¾ã€‚</li>
</ul>
<h4 id="æ’åº">æ’åº<a class="headerlink" href="#æ’åº" title="Permanent link">&para;</a></h4>
<ul>
<li>ã€æ’åºã€‘<code>sort(v: IV) -&gt; IV</code>, <code>sort_desc(v: IV) -&gt; IV</code>: è¿”å› v ä¸­çš„æ—¶é—´åºåˆ—æŒ‰ç…§å€¼æ’åºåçš„ç»“æœã€‚</li>
<li>ã€æŒ‰ label æ’åºã€‘<code>sort_by_label(v: IV, label: String, ...) -&gt; IV</code>, <code>sort_by_label_desc(v: IV, label: String, ...) -&gt; IV</code>: è¿”å› v ä¸­çš„æ—¶é—´åºåˆ—æŒ‰ç…§æŒ‡å®š <code>label</code> æ’åºåçš„ç»“æœï¼›å¦‚æœæ ‡ç­¾ä¸€è‡´ï¼ŒæŒ‰æ ·æœ¬å€¼æ’åºã€‚<ul>
<li>æ’åºé‡‡ç”¨ <a href="https://en.wikipedia.org/wiki/Natural_sort_order">natural sort order</a>ï¼Œå³ <code>z2</code> æ’åœ¨ <code>z11</code> ä¹‹å‰ã€‚</li>
</ul>
</li>
</ul>
<h4 id="ç”¨äº-rv-çš„èšåˆ">ç”¨äº RV çš„èšåˆ<a class="headerlink" href="#ç”¨äº-rv-çš„èšåˆ" title="Permanent link">&para;</a></h4>
<p><code>&lt;aggregation&gt;_over_time(v: RV) -&gt; IV</code>: éšæ—¶é—´èšåˆ v ä¸­çš„æ¯ä¸ªæ—¶é—´åºåˆ—ã€‚<code>&lt;aggregation&gt;</code> å¯ä»¥æ˜¯ç»™å®šåŒºé—´å†…çš„ï¼š</p>
<ul>
<li><code>avg</code>ï¼šå¹³å‡å€¼ï¼›</li>
<li><code>min</code>ï¼šæœ€å°å€¼ï¼›</li>
<li><code>max</code>ï¼šæœ€å¤§å€¼ï¼›</li>
<li><code>sum</code>ï¼šå’Œï¼›</li>
<li><code>count</code>ï¼šè®¡æ•°ï¼›</li>
<li><code>quantile_over_time(Ï†: Scalar, v: RV) -&gt; IV</code>ï¼šç»™å®šåŒºé—´å†…çš„ Ï† åˆ†ä½æ•°ï¼›</li>
<li><code>stddev</code>ï¼šæ ‡å‡†å·®ï¼›</li>
<li><code>stdvar</code>ï¼šæ–¹å·®ï¼›</li>
<li><code>last</code>ï¼šæœ€åä¸€ä¸ªå€¼ï¼›</li>
<li><code>present</code>ï¼šè¿”å›æ‰€æœ‰å‡ºç°è¿‡çš„æ ‡ç­¾å€¼ï¼Œå€¼å‡ä¸º 1ã€‚</li>
</ul>
<h4 id="ç›´æ–¹å›¾ç›¸å…³å‡½æ•°">ç›´æ–¹å›¾ç›¸å…³å‡½æ•°<a class="headerlink" href="#ç›´æ–¹å›¾ç›¸å…³å‡½æ•°" title="Permanent link">&para;</a></h4>
<p><a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#histogram_avg">TODO</a></p>
<h3 id="25-subqueries--å­æŸ¥è¯¢">2.5 Subqueries | å­æŸ¥è¯¢<a class="headerlink" href="#25-subqueries--å­æŸ¥è¯¢" title="Permanent link">&para;</a></h3>
<p>æŸ¥è¯¢ä¸­å¯ä»¥åŒ…å«å­æŸ¥è¯¢ã€‚ä¾‹å¦‚ <code>max_over_time(deriv(rate(distance_covered_total[5s])[30s:5s])[10m:])</code>ï¼Œæˆ‘ä»¬ç”±å†…è€Œå¤–åœ°è§£é‡Šè¿™ä¸ªæŸ¥è¯¢çš„å«ä¹‰ï¼š</p>
<ul>
<li><code>[rv1]</code>: <code>distance_covered_total[5s]</code>ï¼š<code>RV</code>, å– <code>distance_covered_total</code> 5s å†…çš„é‡‡æ ·å€¼<ul>
<li>æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºã€Œ5s çš„å„ä¸ªé‡‡æ ·ç‚¹æ—¶å†… (å„ä¸ª label æ ‡è®°çš„ï¼Œä¸‹åŒ) è½¦è¾†è¡Œè¿›çš„è·ç¦»ã€</li>
</ul>
</li>
<li><code>[iv2]</code>: <code>rate(rv1)</code>: <code>IV</code>ï¼Œè®¡ç®— <code>rv1</code> çš„å¢é•¿ç‡<ul>
<li>æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºã€Œ5s å†…çš„è½¦è¾†è¡Œè¿›çš„è·ç¦»çš„å¢é•¿ç‡ã€ï¼Œå³ã€Œ5s å†…è½¦è¾†çš„é€Ÿåº¦ã€</li>
</ul>
</li>
<li><code>[rv3]</code>: <code>iv2[30s:5s]</code>: <code>RV</code>, å–å¢é•¿ç‡è¿‘ 30s çš„é‡‡æ ·å€¼ï¼Œåˆ†è¾¨ç‡ä¸º 5s<ul>
<li>åˆ†è¾¨ç‡ (resolution) æ˜¯æŒ‡å¤šå°‘ç§’ä¸€ä¸ªæ ·æœ¬ã€‚å³ï¼Œ<code>rv3</code> ç”± <code>iv2</code> è¿‘ 30s å†…æ¯ 5s åšä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœç»„æˆ</li>
<li>æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºã€Œè¿‘ 30s å†…æ¯ 5s çš„è½¦è¾†é€Ÿåº¦ã€</li>
</ul>
</li>
<li><code>[iv4]</code>: <code>deriv(rv3)</code>: <code>IV</code>ï¼Œè®¡ç®— <code>rv3</code> ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„å¯¼æ•°<ul>
<li>æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºã€Œè¿‘ 30s å†…è½¦è¾†é€Ÿåº¦çš„å˜åŒ–ç‡ã€ï¼Œå³ã€Œ30s å†…è½¦è¾†çš„åŠ é€Ÿåº¦ã€</li>
</ul>
</li>
<li><code>[rv5]</code>: <code>iv4[10m:]</code>: <code>RV</code>, å– <code>iv4</code> è¿‘ 10m çš„é‡‡æ ·å€¼<ul>
<li><code>iv4[10m:]</code> è¡¨ç¤ºå– <code>iv4</code> ä¸­æœ€è¿‘ 10m çš„æ•°æ®ï¼Œåˆ†è¾¨ç‡ä¸ºæŸ¥è¯¢çš„é»˜è®¤è®¾ç½®</li>
<li>æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºã€Œè¿‘ 10 åˆ†é’Ÿå†…å„ä¸ªé‡‡æ ·ç‚¹è®¡ç®—å‡ºçš„è½¦è¾†çš„åŠ é€Ÿåº¦ã€</li>
</ul>
</li>
<li><code>[iv6]</code>: <code>max_over_time(rv5)</code>: <code>IV</code>ï¼Œè®¡ç®— <code>rv5</code> ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„æœ€å¤§å€¼<ul>
<li>æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºã€Œè¿‘ 10 åˆ†é’Ÿå†…è½¦è¾†çš„æœ€å¤§åŠ é€Ÿåº¦ã€</li>
</ul>
</li>
</ul>
<h3 id="26-api">2.6 API<a class="headerlink" href="#26-api" title="Permanent link">&para;</a></h3>
<h4 id="261-å³æ—¶æŸ¥è¯¢">2.6.1 å³æ—¶æŸ¥è¯¢<a class="headerlink" href="#261-å³æ—¶æŸ¥è¯¢" title="Permanent link">&para;</a></h4>
<p>å³æ—¶æŸ¥è¯¢è·å– Query åœ¨å½“å‰æ—¶é—´æˆ–ç»™å®šæ—¶é—´ç‚¹çš„ç»“æœï¼›æ¥å£ä¸º <code>/query</code>ï¼Œå‚æ•°åŒ…æ‹¬ <code>query</code>, <code>time</code> å’Œ <code>timeout</code>ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">INSTANT_QUERY</span> <span class="o">=</span> <span class="s2">&quot;query/&quot;</span>

<span class="k">def</span> <span class="nf">instant_query</span><span class="p">(</span><span class="n">promql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">API</span><span class="si">}{</span><span class="n">INSTANT_QUERY</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">promql</span><span class="p">,</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
        <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="n">timeout</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to query </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="n">promql</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;sum(fastapi_requests_total{path!=&quot;/metrics&quot;}) by (path)&#39;&#39;&#39;</span>
<span class="n">time</span> <span class="o">=</span> <span class="s2">&quot;2024-07-01T20:00:00.000Z&quot;</span> <span class="c1"># rfc3339 OR unix_timestamp</span>
<span class="n">timeout</span> <span class="o">=</span> <span class="s2">&quot;10s&quot;</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">instant_query</span><span class="p">(</span><span class="n">promql</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p><img alt="" src="../topics/assets/2024-07-10-18-35-54.png" /></p>
<p>(<code>pprint</code> æ¥è‡ª <code>rich.pretty</code>ã€‚)</p>
<p>ä½¿ç”¨ POST ä¹Ÿèƒ½å¤Ÿè¿›è¡ŒæŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">instant_query</span><span class="p">(</span><span class="n">promql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">API</span><span class="si">}{</span><span class="n">INSTANT_QUERY</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">promql</span><span class="p">,</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
        <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="n">timeout</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to query </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">instant_query</span><span class="p">(</span><span class="n">promql</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p><img alt="" src="../topics/assets/2024-07-10-18-36-24.png" /></p>
<p>æŸ¥è¯¢çš„ç»“æœä¸­æœ‰ä¸€ä¸ª <code>resultType</code>ï¼Œè¡¨ç¤ºç»“æœçš„ç±»å‹ã€‚ç»“æœå¯èƒ½æ˜¯ <code>string</code>, <code>scalar</code>, <code>vector</code> (è¡¨ç¤º Instant Vector), <code>matrix</code> (è¡¨ç¤º Range Vector) ä¹‹ä¸€ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¹Ÿå¯ä»¥æŸ¥è¯¢ RangeVectorï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">promql</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;sum(fastapi_requests_total{path=~&quot;/[^/]*&quot;}) by (path) [10m:2m]&#39;&#39;&#39;</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">instant_query</span><span class="p">(</span><span class="n">promql</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p><img alt="" src="../topics/assets/2024-07-10-18-36-46.png" /></p>
<p>å¦‚æœä¸æä¾› <code>time</code>ï¼Œåˆ™è¡¨ç¤ºæŸ¥è¯¢å½“å‰æ—¶é—´çš„ç»“æœï¼š</p>
<div class="highlight"><pre><span></span><code>result = instant_query(promql, None, timeout)
pprint(result)
</code></pre></div>
<p><img alt="" src="../topics/assets/2024-07-10-18-37-08.png" /></p>
<h4 id="262-èŒƒå›´æŸ¥è¯¢">2.6.2 èŒƒå›´æŸ¥è¯¢<a class="headerlink" href="#262-èŒƒå›´æŸ¥è¯¢" title="Permanent link">&para;</a></h4>
<p>èŒƒå›´æŸ¥è¯¢è·å– Query åœ¨ç»™å®šçš„ä¸€æ®µæ—¶é—´å†…ã€ç»™å®šé¢‘ç‡ä¸‹çš„ç»“æœï¼›æ¥å£ä¸º <code>/query_range</code>ï¼Œå‚æ•°åŒ…æ‹¬ <code>query</code>, <code>start</code>, <code>end</code>, <code>step</code> å’Œ <code>timeout</code>ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">RANGE_QUERY</span> <span class="o">=</span> <span class="s2">&quot;query_range/&quot;</span>

<span class="k">def</span> <span class="nf">range_query</span><span class="p">(</span><span class="n">promql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">API</span><span class="si">}{</span><span class="n">RANGE_QUERY</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">promql</span><span class="p">,</span>
        <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
        <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
        <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
        <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="n">timeout</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to query </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="n">promql</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;sum(fastapi_requests_total{path=~&quot;/v1/[^/]*/&quot;}) by (path)&#39;&#39;&#39;</span>
<span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2024-07-01T20:00:00.000Z&quot;</span>
<span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-07-01T20:10:00.000Z&quot;</span>
<span class="n">step</span> <span class="o">=</span> <span class="s2">&quot;5m&quot;</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">range_query</span><span class="p">(</span><span class="n">promql</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p><img alt="" src="../topics/assets/2024-07-10-18-39-03.png" /></p>
<p>ä½†æ˜¯ï¼Œrange query ä¸æ”¯æŒæŸ¥è¯¢ Range Vectorï¼Œåªèƒ½æŸ¥è¯¢ Instant Vector, Scalar æˆ– Stringã€‚å› ä¸º Range Vector æœ¬èº«å°±æ˜¯ä¸€æ®µæ—¶é—´å†…çš„ Instant Vectorï¼Œæ‰€ä»¥èŒƒå›´æŸ¥è¯¢çš„ç»“æœæ˜¯ä¸€ä¸ª <code>matrix</code>ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">promql</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;sum(fastapi_requests_total) by (path) [10m:2m]&#39;&#39;&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">range_query</span><span class="p">(</span><span class="n">promql</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div>
<p>ç»“æœæ˜¯ <code>Failed to query &lt;API&gt;: {"status":"error","errorType":"bad_data","error":"invalid expression type \"range vector\" for range query, must be Scalar or instant Vector"}</code>ã€‚</p>
<p>å³ä½¿æŸ¥è¯¢ç»“æœæ˜¯ä¸€ä¸ª Scalarï¼Œè¿”å›ç±»å‹ä¹Ÿæ˜¯ä¸€ä¸ª <code>matrix</code>ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">promql</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;pi()&#39;&#39;&#39;</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">range_query</span><span class="p">(</span><span class="n">promql</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p><img alt="" src="../topics/assets/2024-07-10-18-41-11.png" /></p>
<h4 id="å…¶ä»–æ¥å£">å…¶ä»–æ¥å£<a class="headerlink" href="#å…¶ä»–æ¥å£" title="Permanent link">&para;</a></h4>
<p>è¿˜æœ‰æ›´å¤šæ¥å£å¯ä»¥ç©ï¼è¯¦è§ <a href="https://prometheus.io/docs/prometheus/latest/querying/api/">HTTP API | Prometheus</a></p>
<h2 id="3-examples">3 Examples<a class="headerlink" href="#3-examples" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>è¿™ä¸€èŠ‚ä¼šè®°å½•ä¸€äº›æˆ‘ç”¨åˆ° / è§åˆ°çš„æŸ¥è¯¢æ ·ä¾‹ã€‚</p>
</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="æœ€åæ›´æ–°">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2024-09-10T07:02:21+00:00" locale="zh"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-09-10</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="åˆ›å»ºæ—¥æœŸ">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2024-09-10T07:02:21+00:00" locale="zh"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-09-10</span>
  </span>

    
    
    
  </aside>


  


  


<div id="__comments">

<h3>é¢œè‰²ä¸»é¢˜è°ƒæ•´</h3>

<!-- <div class="tx-switch">
<button data-md-color-scheme="default"><code>default</code></button>
<button data-md-color-scheme="slate"><code>slate</code></button>
</div>

<script>
var buttons = document.querySelectorAll("button[data-md-color-scheme]")
buttons.forEach(function(button) {
        button.addEventListener("click", function() {
        var attr = this.getAttribute("data-md-color-scheme")
        document.body.setAttribute("data-md-color-scheme", attr)
        localStorage.setItem("data-md-color-scheme",attr);
        updateScheme();
        })
})
</script> -->

<div class="tx-switch">
<button class="button1" data-md-color-primary="red" style="background-color:red">red</button>
<button class="button1" data-md-color-primary="pink" style="background-color:pink;color:black">pink</button>
<button class="button1" data-md-color-primary="purple" style="background-color:purple">purple</button>
<button class="button1" data-md-color-primary="indigo" style="background-color:indigo">indigo</button>
<button class="button1" data-md-color-primary="blue" style="background-color:blue">blue</button>
<button class="button1" data-md-color-primary="cyan" style="background-color:cyan;color:black">cyan</button>
<button class="button1" data-md-color-primary="teal" style="background-color:teal">teal</button>
<button class="button1" data-md-color-primary="green" style="background-color:green">green</button>
<button class="button1" data-md-color-primary="lime" style="background-color:lime;color:black">lime</button>
<button class="button1" data-md-color-primary="orange" style="background-color:orange;color:black">orange</button>
<button class="button1" data-md-color-primary="brown" style="background-color:brown;border-radius=3px">brown</button>
<button class="button1" data-md-color-primary="grey" style="background-color:grey">grey</button>
<button class="button1" data-md-color-primary="black" style="background-color:black">black</button>
<button class="button1" data-md-color-primary="white" style="background-color:white;color:black">white</button>
</div>

<script>
var buttons = document.querySelectorAll("button[data-md-color-primary]")
buttons.forEach(function(button) {
        button.addEventListener("click", function() {
        var attr = this.getAttribute("data-md-color-primary")
        document.body.setAttribute("data-md-color-primary", attr)
        localStorage.setItem("data-md-color-primary",attr);
        })
})
</script>

<h2 ><!-- è¯„è®º -->è¯„è®ºåŒº~</h2>

æœ‰ç”¨çš„è¯è¯·ç»™æˆ‘ä¸ªèµå’Œ star => <a href="https://github.com/xuan-insr/xuan-insr.github.io"><img alt="GitHub stars" src="https://img.shields.io/github/stars/xuan-insr/xuan-insr.github.io.svg?style=plastic&amp;label=Stars"></a>

</br>

å¿«æ¥è·Ÿæˆ‘èŠå¤©~

</div>

<script src="https://giscus.app/client.js"
        data-repo="xuan-insr/discussion"
        data-repo-id="R_kgDOIUW7XA"
        data-category="General"
        data-category-id="DIC_kwDOIUW7XM4CSOC3"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="dark"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>

updateScheme();

</script>

<!-- Synchronize Giscus theme with palette -->
<script>
var giscus = document.querySelector("script[src*=giscus]")

/* Set palette on initial load */
var palette = __md_get("__palette")
if (palette && typeof palette.color === "object") {
    var theme = palette.color.scheme === "slate" ? "dark" : "light"
    giscus.setAttribute("data-theme", theme) 
}

/* Register event handlers after documented loaded */
document.addEventListener("DOMContentLoaded", function() {
    var ref = document.querySelector("[data-md-component=palette]")
    ref.addEventListener("change", function() {
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "dark" : "light"
        localStorage.setItem("data-md-color-scheme", palette.color.scheme === "slate" ? "slate" : "default");
        /* Instruct Giscus to change theme */
        var frame = document.querySelector(".giscus-frame")
        frame.contentWindow.postMessage(
        { giscus: { setConfig: { theme } } },
        "https://giscus.app"
        )
    }
    })
})
</script>
      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  å›åˆ°é¡µé¢é¡¶éƒ¨
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      æœ¬é¡µé¢çš„å…¨éƒ¨å†…å®¹åœ¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh">CC BY-SA 4.0</a> å’Œ <a href="https://github.com/zTrix/sata-license">SATA</a> åè®®ä¹‹æ¡æ¬¾ä¸‹æä¾›ï¼Œé™„åŠ æ¡æ¬¾äº¦å¯èƒ½åº”ç”¨
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/smd1121" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:xianyuxuan@outlook.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "content.code.annotate", "navigation.indexes", "navigation.top", "navigation.sections", "navigation.expand", "toc.follow"], "search": "../../assets/javascripts/workers/search.07f07601.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.56dfad97.min.js"></script>
      
        <script src="../../js/timeago.min.js"></script>
      
        <script src="../../js/timeago_mkdocs_material.js"></script>
      
        <script src="../../from_oi_wiki/js/extra.js"></script>
      
        <script src="../../js/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../../js/tablesort.js"></script>
      
        <script src="../../termynal.js"></script>
      
    
  </body>
</html>